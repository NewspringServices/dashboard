<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Newspring</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f7f7f7;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.app {
  width: 100%;
  max-width: 420px;
  padding: 15px;
}

/* HEADER */
.header {
  text-align: center;
  margin-bottom: 10px;
}

.header img {
  max-width: 130px;
  margin-bottom: 10px;
}

.info {
  font-weight: bold;
}

/* STATUS */
.status-card {
  background: #b71c1c;
  color: white;
  padding: 15px;
  border-radius: 14px;
  text-align: center;
  margin-bottom: 10px;
}

#estadoLabel {
  font-size: 18px;
  font-weight: bold;
}

/* HORAS */
#horas {
  text-align: center;
  font-weight: bold;
  margin-bottom: 10px;
}

#horaInicio, #horaFim {
  display: none;
}

/* BOT√ïES ESTADO */
#tipoButtons {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.tipo-btn {
  padding: 18px;
  border: none;
  border-radius: 14px;
  color: white;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
}

[data-tipo="login"] { background:#2e7d32; }
[data-tipo="pausa1"],
[data-tipo="pausa2"],
[data-tipo="refeicao"] { background:#8bc34a; }
[data-tipo="formacao"] { background:#0b1f5e; }
[data-tipo="logout"] { background:#d50000; }

/* A√á√ïES */
.actions {
  text-align: center;
  margin-top: 10px;
}

.actions button {
  padding: 12px 25px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  font-weight: bold;
}

#btnSubmeter { background:#28a745; color:white; }
#btnTerminar { background:#d50000; color:white; display:none; }

#mensagem {
  margin-top: 8px;
  font-weight: bold;
}

/* PRODU√á√ÉO */
.form-container {
  background: white;
  padding: 20px;
  border-radius: 14px;
  margin-top: 20px;
  box-shadow: 0 4px 8px rgba(0,0,0,.1);
}

.titulo-gama {
  text-align: center;
  color: #28a745;
  margin-bottom: 15px;
}

.form-group {
  margin-bottom: 12px;
}

input, select {
  width: 100%;
  padding: 10px;
}

.button-container {
  display: flex;
  justify-content: space-between;
}

.button-container button {
  width: 48%;
}
</style>
</head>

<body>
<div class="app">

<!-- HEADER -->
<div class="header">
  <img src="logo.png" />
  <div class="info" id="infoData"></div>
  <div class="info" id="infoNome"></div>
</div>

<!-- STATUS -->
<div class="status-card">
  <div id="estadoLabel">üî¥ OFFLINE</div>
</div>

<!-- HORAS -->
<div id="horas">
  <div id="horaInicio"></div>
  <div id="horaFim"></div>
</div>

<!-- BOT√ïES -->
<div id="tipoButtons">
  <button class="tipo-btn" data-tipo="login">Login</button>
  <button class="tipo-btn" data-tipo="pausa1">Pausa 1</button>
  <button class="tipo-btn" data-tipo="pausa2">Pausa 2</button>
  <button class="tipo-btn" data-tipo="refeicao">Refei√ß√£o</button>
  <button class="tipo-btn" data-tipo="formacao">Forma√ß√£o</button>
  <button class="tipo-btn" data-tipo="logout">Logout</button>
</div>

<!-- A√á√ïES -->
<div class="actions">
  <button id="btnSubmeter" disabled>Submeter</button>
  <button id="btnTerminar">Finalizar</button>
  <div id="mensagem"></div>
</div>

<!-- PRODU√á√ÉO -->
<div class="form-container">
  <h2 class="titulo-gama">Produ√ß√£o - Gest√£o Ocorr√™ncias</h2>
  <form id="gamaForm">
    <div class="form-group">
      <label>Processo:</label>
      <input type="text" id="processoGama" required />
    </div>

    <div class="form-group">
      <label>Documentos Tratados:</label>
      <input type="number" id="documentos" required />
    </div>

    <div class="form-group">
      <label>Tarefa Finalizada:</label>
      <select id="tarefaFinalizada">
        <option>Reembolsos Multicare</option>
        <option>Forma√ß√£o/Meetings</option>
      </select>
    </div>

    <div class="form-group">
      <label>Tempo da Tarefa:</label>
      <input type="text" id="tempoTarefa" readonly />
    </div>

    <div class="button-container">
      <button type="button" id="startButton">Iniciar Tarefa</button>
      <button type="button" id="endButton" disabled>Finalizar Tarefa</button>
    </div>

    <div id="responseMessage"></div>
  </form>
</div>

</div>

<script>
/* ================= DADOS ================= */
const user = "EX04904";
const nome = "Telma Sofia Pereira Rosa";

const SUPABASE_URL = 'https://bijndfsxrzjviwrdvwms.supabase.co';
const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpam5kZnN4cnpqdml3cmR2d21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NTA5NTIsImV4cCI6MjA2NjQyNjk1Mn0.EWaFInuqTaxvnjytb40DdnflEbBrbSYcViKLYc_kKBk';

/* ================= ESTADOS ================= */
let tipoSelecionado = "";
let inicioDataHora;

const estadoLabel = document.getElementById("estadoLabel");
const btnSub = document.getElementById("btnSubmeter");
const btnTerm = document.getElementById("btnTerminar");
const msgEl = document.getElementById("mensagem");
const horaInicioEl = document.getElementById("horaInicio");
const horaFimEl = document.getElementById("horaFim");

document.getElementById("infoNome").textContent = "üë§ " + nome;
document.getElementById("infoData").textContent =
  "üìÖ " + new Date().toLocaleDateString("pt-BR");

function formatarDataHoraLocal(d){
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+"T"+
         String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")+":"+String(d.getSeconds()).padStart(2,"0");
}

async function enviarAoSupabase(dados){
  await fetch(`${SUPABASE_URL}/rest/v1/BPO_registosNSS`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "apikey":SUPABASE_API_KEY,
      "Authorization":`Bearer ${SUPABASE_API_KEY}`
    },
    body:JSON.stringify(dados)
  });
}

document.querySelectorAll(".tipo-btn").forEach(btn=>{
  btn.onclick=()=>{
    tipoSelecionado=btn.dataset.tipo;
    inicioDataHora=new Date();
    btnSub.disabled=false;
    btnSub.style.display="inline-block";
    btnTerm.style.display="none";
    horaFimEl.style.display="none";
    msgEl.textContent="";

    if(tipoSelecionado==="login"){ estadoLabel.textContent="üü¢ ONLINE"; horaInicioEl.style.display="none"; }
    else if(tipoSelecionado==="logout"){ estadoLabel.textContent="üî¥ OFFLINE"; horaInicioEl.style.display="none"; }
    else {
      estadoLabel.textContent="‚è∏ "+btn.textContent;
      horaInicioEl.textContent="üïí In√≠cio: "+inicioDataHora.toLocaleTimeString("pt-BR");
      horaInicioEl.style.display="block";
    }
  };
});

btnSub.onclick=async()=>{
  if(tipoSelecionado==="login"||tipoSelecionado==="logout"){
    await enviarAoSupabase({data:formatarDataHoraLocal(inicioDataHora).split("T")[0],user,nome,tipo:tipoSelecionado,inicio:formatarDataHoraLocal(inicioDataHora),fim:null,duracao:null});
    msgEl.textContent="‚úîÔ∏è Registo enviado";
    btnSub.disabled=true;
  } else {
    btnSub.style.display="none";
    btnTerm.style.display="inline-block";
  }
};

btnTerm.onclick=async()=>{
  const fim=new Date();
  const dur=(fim-inicioDataHora)/3600000;
  horaFimEl.textContent="üïî Fim: "+fim.toLocaleTimeString("pt-BR");
  horaFimEl.style.display="block";

  await enviarAoSupabase({data:formatarDataHoraLocal(inicioDataHora).split("T")[0],user,nome,tipo:tipoSelecionado,inicio:formatarDataHoraLocal(inicioDataHora),fim:formatarDataHoraLocal(fim),duracao:Number(dur.toFixed(3))});
  msgEl.textContent="‚úîÔ∏è Registo enviado";
  btnTerm.style.display="none";
  btnSub.style.display="inline-block";
  btnSub.disabled=true;
};

/* ================= PRODU√á√ÉO (IGUAL AO TEU) ================= */
let startTime,endTime,timerInterval;
const startButton=document.getElementById('startButton');
const endButton=document.getElementById('endButton');
const tempoTarefa=document.getElementById('tempoTarefa');
const responseMessage=document.getElementById('responseMessage');

function formatTime(seconds){
  const h=Math.floor(seconds/3600);
  const m=Math.floor((seconds%3600)/60);
  const s=seconds%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function formatDate(d){
  return d.getDate().toString().padStart(2,'0')+"/"+(d.getMonth()+1).toString().padStart(2,'0')+"/"+d.getFullYear()+" "+
         d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0')+":"+d.getSeconds().toString().padStart(2,'0');
}

startButton.onclick=()=>{
  startTime=new Date();
  startButton.disabled=true;
  endButton.disabled=false;
  timerInterval=setInterval(()=>{
    tempoTarefa.value=formatTime(Math.floor((new Date()-startTime)/1000));
  },1000);
};

endButton.onclick=()=>{
  clearInterval(timerInterval);
  endTime=new Date();
  endButton.disabled=true;

  fetch(`${SUPABASE_URL}/rest/v1/BPO_dadosprodu√ß√£o`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "apikey":SUPABASE_API_KEY,
      "Authorization":`Bearer ${SUPABASE_API_KEY}`
    },
    body:JSON.stringify({
      inicio:formatDate(startTime),
      fim:formatDate(endTime),
      colaborador:nome,
      processoGama:document.getElementById('processoGama').value,
      Documentos:Number(document.getElementById('documentos').value),
      tarefaFinalizada:document.getElementById('tarefaFinalizada').value,
      tempo:tempoTarefa.value
    })
  });

  responseMessage.textContent="‚úîÔ∏è Produ√ß√£o enviada";
  document.getElementById('gamaForm').reset();
  startButton.disabled=false;
};
</script>
</body>
</html>
