<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Newspring</title>

<style>
:root {
  --primary: #0b5ed7;
  --success: #198754;
  --warning: #ffc107;
  --danger: #dc3545;
  --bg: #f4f6f9;
  --card: #ffffff;
  --text: #212529;
  --border: #dee2e6;
}

/* ================= BODY ================= */
body {
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  margin: 0;
  background: var(--bg);
  display: flex;
  justify-content: center;
  min-height: 100vh;
}

.app {
  width: 100%;
  max-width: 480px;
  padding: 20px;
}

/* ================= HEADER ================= */
.header {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  text-align: center;
  margin-bottom: 12px;
}

.header img {
  max-width: 110px;
  margin-bottom: 8px;
}

.info {
  font-size: 14px;
  color: #495057;
}

/* ================= STATUS ================= */
.status-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-left: 6px solid var(--danger);
  border-radius: 8px;
  padding: 14px;
  margin-bottom: 12px;
}

#estadoLabel {
  font-size: 16px;
  font-weight: 600;
}

/* ================= HORAS ================= */
#horas {
  font-size: 13px;
  color: #495057;
  margin-bottom: 10px;
}

#horaInicio, #horaFim {
  display: none;
}

/* ================= BOT√ïES ESTADO ================= */
#tipoButtons {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  margin-bottom: 10px;
}

.tipo-btn {
  padding: 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--text);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

.tipo-btn:hover {
  background: #e9ecef;
}

[data-tipo="login"] { border-left: 4px solid var(--success); }
[data-tipo="logout"] { border-left: 4px solid var(--danger); }
[data-tipo^="pausa"],
[data-tipo="refeicao"] { border-left: 4px solid var(--warning); }
[data-tipo="formacao"] { border-left: 4px solid var(--primary); }

/* ================= HIST√ìRICO ================= */
#historicoContainer {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  max-height: 200px;
  overflow-y: auto;
}

#historicoContainer h3 {
  font-size: 14px;
  color: #495057;
  margin-bottom: 8px;
}

.historico-item {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  font-size: 13px;
  border-bottom: 1px solid #eee;
}

.historico-item:last-child {
  border-bottom: none;
}

.historico-login { color: var(--success); }
.historico-logout { color: var(--danger); }
.historico-pausa { color: var(--warning); }
.historico-refeicao { color: var(--warning); }
.historico-formacao { color: var(--primary); }

/* ================= A√á√ïES ================= */
.actions {
  text-align: center;
  margin-top: 10px;
}

.actions button {
  padding: 10px 18px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  border: none;
  cursor: pointer;
}

#btnSubmeter {
  background: var(--primary);
  color: white;
}

#btnTerminar {
  background: var(--danger);
  color: white;
  display: none;
}

#mensagem {
  margin-top: 8px;
  font-weight: 600;
}

/* ================= PRODU√á√ÉO ================= */
.form-container {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 20px;
  margin-top: 20px;
}

.titulo-gama {
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 16px;
}

.form-group {
  margin-bottom: 14px;
}

.form-group label {
  font-size: 13px;
  font-weight: 600;
  color: #495057;
  margin-bottom: 4px;
}

input, select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 6px;
  border: 1px solid var(--border);
  font-size: 14px;
}

input:focus, select:focus {
  border-color: var(--primary);
  outline: none;
}

.button-container {
  display: flex;
  justify-content: space-between;
  margin-top: 14px;
}

.button-container button {
  width: 48%;
  padding: 10px 0;
  border-radius: 6px;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

#startButton {
  background: var(--success);
  color: white;
}

#endButton {
  background: var(--danger);
  color: white;
}

#tempoTarefa {
  background: #f1f3f5;
  text-align: center;
  font-weight: 600;
}

#responseMessage {
  text-align: center;
  margin-top: 12px;
  font-weight: 600;
  color: var(--success);
}
</style>
</head>

<body>
<div class="app">

<!-- HEADER -->
<div class="header">
  <img src="logo.png" />
  <div class="info" id="infoData"></div>
  <div class="info" id="infoNome"></div>
</div>

<!-- STATUS -->
<div class="status-card">
  <div id="estadoLabel">üî¥ OFFLINE</div>
</div>

<!-- HORAS -->
<div id="horas">
  <div id="horaInicio"></div>
  <div id="horaFim"></div>
</div>

<!-- BOT√ïES -->
<div id="tipoButtons">
  <button class="tipo-btn" data-tipo="login">Login</button>
  <button class="tipo-btn" data-tipo="pausa1">Pausa 1</button>
  <button class="tipo-btn" data-tipo="pausa2">Pausa 2</button>
  <button class="tipo-btn" data-tipo="refeicao">Refei√ß√£o</button>
  <button class="tipo-btn" data-tipo="formacao">Forma√ß√£o</button>
  <button class="tipo-btn" data-tipo="logout">Logout</button>
</div>

<!-- HIST√ìRICO -->
<div id="historicoContainer">
  <h3>Hist√≥rico de A√ß√µes</h3>
  <div id="historicoList"></div>
</div>

<!-- A√á√ïES -->
<div class="actions">
  <button id="btnSubmeter" disabled>Submeter</button>
  <button id="btnTerminar">Finalizar</button>
  <div id="mensagem"></div>
</div>

<!-- PRODU√á√ÉO -->
<div class="form-container">
  <h2 class="titulo-gama">Produ√ß√£o - Gest√£o Ocorr√™ncias</h2>
  <form id="gamaForm">
    <div class="form-group">
      <label>Processo</label>
      <input type="text" id="processoGama" required />
    </div>

    <div class="form-group">
      <label>Documentos Tratados</label>
      <input type="number" id="documentos" required />
    </div>

    <div class="form-group">
      <label>Tarefa Finalizada</label>
      <select id="tarefaFinalizada">
        <option>Reembolsos Multicare</option>
        <option>Forma√ß√£o/Meetings</option>
      </select>
    </div>

    <div class="form-group">
      <label>Tempo da Tarefa</label>
      <input type="text" id="tempoTarefa" readonly />
    </div>

    <div class="button-container">
      <button type="button" id="startButton">Iniciar</button>
      <button type="button" id="endButton" disabled>Finalizar</button>
    </div>

    <div id="responseMessage"></div>
  </form>
</div>

</div>

<script>
/* ================= DADOS ================= */
const user = "EX04904";
const nome = "Telma Sofia Pereira Rosa";

const SUPABASE_URL = 'https://bijndfsxrzjviwrdvwms.supabase.co';
const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpam5kZnN4cnpqdml3cmR2d21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NTA5NTIsImV4cCI6MjA2NjQyNjk1Mn0.EWaFInuqTaxvnjytb40DdnflEbBrbSYcViKLYc_kKBk';

/* ================= ESTADOS ================= */
let tipoSelecionado = "";
let inicioDataHora;

const estadoLabel = document.getElementById("estadoLabel");
const btnSub = document.getElementById("btnSubmeter");
const btnTerm = document.getElementById("btnTerminar");
const msgEl = document.getElementById("mensagem");
const horaInicioEl = document.getElementById("horaInicio");
const horaFimEl = document.getElementById("horaFim");
const historicoList = document.getElementById("historicoList");

document.getElementById("infoNome").textContent = "üë§ " + nome;
document.getElementById("infoData").textContent =
  "üìÖ " + new Date().toLocaleDateString("pt-BR");

function formatarDataHoraLocal(d){
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+"T"+
         String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")+":"+String(d.getSeconds()).padStart(2,"0");
}

function registrarHistorico(tipo, hora){
  const div = document.createElement('div');
  div.className = 'historico-item historico-' + tipo;
  div.textContent = hora + ' - ' + tipo.charAt(0).toUpperCase() + tipo.slice(1);
  historicoList.prepend(div);
}

async function enviarAoSupabase(dados){
  await fetch(`${SUPABASE_URL}/rest/v1/BPO_registosNSS`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "apikey":SUPABASE_API_KEY,
      "Authorization":`Bearer ${SUPABASE_API_KEY}`
    },
    body:JSON.stringify(dados)
  });
}

document.querySelectorAll(".tipo-btn").forEach(btn=>{
  btn.onclick=()=>{
    tipoSelecionado=btn.dataset.tipo;
    inicioDataHora=new Date();
    btnSub.disabled=false;
    btnSub.style.display="inline-block";
    btnTerm.style.display="none";
    horaFimEl.style.display="none";
    msgEl.textContent="";

    if(tipoSelecionado==="login"){ 
      estadoLabel.textContent="üü¢ ONLINE"; 
      horaInicioEl.style.display="none"; 
      document.querySelector(".status-card").style.borderLeftColor="var(--success)";
      registrarHistorico("login", inicioDataHora.toLocaleTimeString("pt-BR"));
    }
    else if(tipoSelecionado==="logout"){ 
      estadoLabel.textContent="üî¥ OFFLINE"; 
      horaInicioEl.style.display="none"; 
      document.querySelector(".status-card").style.borderLeftColor="var(--danger)";
      registrarHistorico("logout", inicioDataHora.toLocaleTimeString("pt-BR"));
    }
    else {
      estadoLabel.textContent="‚è∏ "+btn.textContent;
      horaInicioEl.textContent="üïí In√≠cio: "+inicioDataHora.toLocaleTimeString("pt-BR");
      horaInicioEl.style.display="block";
      let tipoHist = tipoSelecionado;
      if(tipoSelecionado.startsWith("pausa")) tipoHist = "pausa";
      registrarHistorico(tipoHist, inicioDataHora.toLocaleTimeString("pt-BR"));
    }
  };
});

/* ================= SUBMETER E FINALIZAR ================= */
btnSub.onclick = async () => {
  if (tipoSelecionado === "login" || tipoSelecionado === "logout") {
    await enviarAoSupabase({
      data: formatarDataHoraLocal(inicioDataHora).split("T")[0],
      user,
      nome,
      tipo: tipoSelecionado,
      inicio: formatarDataHoraLocal(inicioDataHora),
      fim: null,
      duracao: null
    });
    msgEl.textContent = "‚úîÔ∏è Registo enviado";
    btnSub.disabled = true;
  } else {
    btnSub.style.display = "none";
    btnTerm.style.display = "inline-block";
    
    const terminarHandler = async () => {
      const fimDataHora = new Date();
      const duracaoHoras = (fimDataHora - inicioDataHora) / 3600000;

      horaFimEl.textContent = "üïî Fim: " + fimDataHora.toLocaleTimeString("pt-BR");
      horaFimEl.style.display = "block";

      await enviarAoSupabase({
        data: formatarDataHoraLocal(inicioDataHora).split("T")[0],
        user,
        nome,
        tipo: tipoSelecionado,
        inicio: formatarDataHoraLocal(inicioDataHora),
        fim: formatarDataHoraLocal(fimDataHora),
        duracao: parseFloat(duracaoHoras.toFixed(3))
      });

      msgEl.textContent = "‚úîÔ∏è Registo enviado";

      setTimeout(() => {
        horaInicioEl.style.display = "none";
        horaFimEl.style.display = "none";
        estadoLabel.textContent = "üü¢ ONLINE";
        msgEl.textContent = "";
        tipoSelecionado = "";
        btnTerm.style.display = "none";
        btnSub.style.display = "inline-block";
        btnSub.disabled = true;
        document.querySelector(".status-card").style.borderLeftColor="var(--success)";
      }, 5000);

      btnTerm.removeEventListener("click", terminarHandler);
    };

    btnTerm.addEventListener("click", terminarHandler);
  }
};

/* ================= PRODU√á√ÉO ================= */
let startTime,endTime,timerInterval;
const startButton=document.getElementById('startButton');
const endButton=document.getElementById('endButton');
const tempoTarefa=document.getElementById('tempoTarefa');
const responseMessage=document.getElementById('responseMessage');

function formatTime(seconds){
  const h=Math.floor(seconds/3600);
  const m=Math.floor((seconds%3600)/60);
  const s=seconds%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function formatDate(d){
  return d.getDate().toString().padStart(2,'0')+"/"+(d.getMonth()+1).toString().padStart(2,'0')+"/"+d.getFullYear()+" "+
         d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0')+":"+d.getSeconds().toString().padStart(2,'0');
}

startButton.onclick=()=>{
  responseMessage.textContent = "";
  
  startTime=new Date();
  startButton.disabled=true;
  endButton.disabled=false;
  timerInterval=setInterval(()=>{
    tempoTarefa.value=formatTime(Math.floor((new Date()-startTime)/1000));
  },1000);
};

endButton.onclick=()=>{
  clearInterval(timerInterval);
  endTime=new Date();
  endButton.disabled=true;

  fetch(`${SUPABASE_URL}/rest/v1/BPO_dadosprodu√ß√£o`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "apikey":SUPABASE_API_KEY,
      "Authorization":`Bearer ${SUPABASE_API_KEY}`
    },
    body:JSON.stringify({
      inicio:formatDate(startTime),
      fim:formatDate(endTime),
      colaborador:nome,
      processoGama:document.getElementById('processoGama').value,
      Documentos:Number(document.getElementById('documentos').value),
      tarefaFinalizada:document.getElementById('tarefaFinalizada').value,
      tempo:tempoTarefa.value
    })
  });

  responseMessage.textContent="‚úîÔ∏è Produ√ß√£o enviada";
  document.getElementById('gamaForm').reset();
  startButton.disabled=false;
};
</script>

</body>
</html>
