<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Newspring</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 10px;
  background: #f7f7f7;
}

#topImage {
  display: block;
  margin: 0 auto 20px auto;
  max-width: 150px;
  height: auto;
}
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: #f7f7f7;

  /* Centraliza√ß√£o completa */
  display: flex;
  flex-direction: column;
  align-items: center; /* horizontal */
  justify-content: center; /* vertical */
  min-height: 100vh;
}

.form-container {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 400px;
  margin: 20px auto; /* j√° centraliza horizontalmente */
}
/* Bot√µes tipo registro */
.tipo-btn {
  padding: 10px 20px;       
  border: none;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
  transition: background 0.2s;
}

/* Cores por tipo */
.tipo-btn[data-tipo="login"],
.tipo-btn[data-tipo="logout"] {
  background-color: #dc3545; /* vermelho */
}

.tipo-btn[data-tipo="pausa1"],
.tipo-btn[data-tipo="pausa2"] {
  background-color: #ffc107; /* amarelo */
  color: black; /* melhor contraste */
}

.tipo-btn[data-tipo="refeicao"] {
  background-color: #fd7e14; /* laranja */
}

.tipo-btn[data-tipo="formacao"] {
  background-color: #0d6efd; /* azul escuro */
}

/* Hover */
.tipo-btn[data-tipo="login"]:hover,
.tipo-btn[data-tipo="logout"]:hover { background-color: #c82333; }
.tipo-btn[data-tipo="pausa1"]:hover,
.tipo-btn[data-tipo="pausa2"]:hover { background-color: #e0a800; color: black; }
.tipo-btn[data-tipo="refeicao"]:hover { background-color: #e36a0c; }
.tipo-btn[data-tipo="formacao"]:hover { background-color: #084298; }

/* Ativo */
.tipo-btn.active { filter: brightness(85%); }

/* Bot√µes Submeter e Terminar ficam verdes */
#btnSubmeter, #btnTerminar {
  padding: 10px 20px;       
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  font-size: 16px;
  background-color: #28a745; 
  color: white;
  transition: background 0.2s;
}

#btnSubmeter:hover, #btnTerminar:hover {
  background-color: #218838;
}




/* Status e mensagens */
#statusContainer {
  text-align: center;
  margin-bottom: 20px;
}

#cronometro, #horaInicio, #horaFim, #mensagem {
  display: block;
  margin: 5px 0;
  font-weight: bold;
  font-size: 14px;
  color: green;
}

#btnSubmeter, #btnTerminar {
  padding: 5px 15px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  margin: 0 5px;
}

#btnSubmeter { background-color: #28a745; color:white; }
#btnTerminar { background-color: #dc3545; color:white; }

/* GAMa */
.form-container {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 400px;
  margin: auto 0;
}

.form-group {
  margin-bottom: 15px;
}

select, input[type="text"], input[type="number"], input[type="radio"] {
  width: 100%;
  padding: 10px;
  margin-top: 5px;
  border-radius: 4px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

.button-container {
  display: flex;
  justify-content: space-between;
}

.button-container button {
  width: 48%;
}

.message {
  text-align: center;
  margin-top: 20px;
  padding: 10px;
  border-radius: 4px;
  display: none;
}

.success { background-color: #d4edda; color: #155724; }
.error { background-color: #f8d7da; color: #721c24; }

.titulo-gama {
  font-size: 20px;
  color: #28a745;
  text-align: center;
  margin-bottom: 20px;
}
</style>
</head>
<body>

<img id="topImage" src="logo.png" alt="Logo Newspring" />

<!-- Bot√µes tipo registro horizontais -->
<div id="tipoButtons">
  <button class="tipo-btn" data-tipo="login">Login</button>
  <button class="tipo-btn" data-tipo="pausa1">Pausa 1</button>
  <button class="tipo-btn" data-tipo="pausa2">Pausa 2</button>
  <button class="tipo-btn" data-tipo="refeicao">Refei√ß√£o</button>
  <button class="tipo-btn" data-tipo="formacao">Forma√ß√£o</button>
  <button class="tipo-btn" data-tipo="logout">Logout</button>
</div>

<!-- Status -->
<div id="statusContainer">
  <span id="cronometro">‚è± 00:00:00</span>
  <span id="horaInicio"></span>
  <span id="horaFim"></span>
  <span id="mensagem"></span>
</div>

<!-- Bot√µes submeter/terminar -->
<div style="text-align:center; margin-bottom:20px;">
  <button id="btnSubmeter" onclick="submeter()" disabled>Submeter</button>
  <button id="btnTerminar" onclick="terminar()" style="display:none;">Terminar</button>
</div>

<!-- Formul√°rio GAMa -->
<div class="form-container">
  <h2 class="titulo-gama">Produ√ß√£o - Gest√£o Ocorr√™ncias</h2>
  <form id="gamaForm">
    <div class="form-group">
      <label for="processoGama">Processo:</label>
      <input type="text" id="processoGama" name="processoGama" required />
    </div>
    <div class="form-group">
      <label for="documentos">Documentos Tratados:</label>
      <input type="number" id="documentos" name="documentos" required />
    </div>
    <div class="form-group">
      <label for="tarefaFinalizada">Tarefa Finalizada:</label>
      <select id="tarefaFinalizada" name="tarefaFinalizada" required>
        <option value="Reembolsos Multicare">Reembolsos Multicare</option>
        <option value="Forma√ß√£o/Meetings">Forma√ß√£o/Meetings</option>
      </select>
    </div>
    <div class="form-group">
      <label for="tempoTarefa">Tempo da Tarefa:</label>
      <input type="text" id="tempoTarefa" name="tempoTarefa" readonly />
    </div>
    <div class="form-group button-container">
      <button type="button" id="startButton">Iniciar Tarefa</button>
      <button type="button" id="endButton" disabled>Finalizar Tarefa</button>
    </div>
    <div id="responseMessage" class="message"></div>
  </form>
</div>

<script>
const user = "EX04904";
const nome = "Telma Sofia Pereira Rosa";
const tipoBtns = document.querySelectorAll('.tipo-btn');
const btnSub = document.getElementById('btnSubmeter');
const btnTerm = document.getElementById('btnTerminar');
const cronometro = document.getElementById('cronometro');
const horaIni = document.getElementById('horaInicio');
const horaFim = document.getElementById('horaFim');
const msgEl = document.getElementById('mensagem');
let tipoSelecionado = "";
let inicioDataHora, fimDataHora, timer, segundos=0;

const SUPABASE_URL = 'https://bijndfsxrzjviwrdvwms.supabase.co';
const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpam5kZnN4cnpqdml3cmR2d21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NTA5NTIsImV4cCI6MjA2NjQyNjk1Mn0.EWaFInuqTaxvnjytb40DdnflEbBrbSYcViKLYc_kKBk';

// Mostrar data
const infoData = document.createElement('div');
infoData.style.fontWeight='bold';
infoData.style.textAlign='center';
infoData.style.marginBottom='15px';
document.body.insertBefore(infoData, document.getElementById('tipoButtons'));
function mostrarDataAtual() {
  const hoje = new Date();
  infoData.textContent = `üìÖ ${hoje.toLocaleDateString('pt-BR')}`;
}
mostrarDataAtual();

// Sele√ß√£o tipo
tipoBtns.forEach(btn=>{
  btn.addEventListener('click', ()=> {
    tipoSelecionado = btn.getAttribute('data-tipo');
    tipoBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    resetar();
    btnSub.disabled = false;
    msgEl.textContent = "";
  });
});

function iniciarCronometro(){
  segundos=0;
  cronometro.style.display='inline-block';
  cronometro.textContent=`‚è± 00:00:00`;
  timer=setInterval(()=>{
    segundos++;
    const h=String(Math.floor(segundos/3600)).padStart(2,'0');
    const m=String(Math.floor((segundos%3600)/60)).padStart(2,'0');
    const s=String(segundos%60).padStart(2,'0');
    cronometro.textContent=`‚è± ${h}:${m}:${s}`;
  },1000);
}
function pararCronometro(){ clearInterval(timer); }
function mostrarMensagem(texto, sucesso=true){ msgEl.textContent = texto; msgEl.style.color = sucesso?'green':'red'; }
function resetar(){
  pararCronometro();
  cronometro.style.display='none';
  cronometro.textContent='‚è± 00:00:00';
  horaIni.style.display='none'; horaIni.textContent='';
  horaFim.style.display='none'; horaFim.textContent='';
  btnTerm.style.display='none';
  btnSub.style.display='inline-block';
  btnSub.disabled = !tipoSelecionado;
  msgEl.textContent="";
}

// Enviar ao Supabase
async function enviarAoSupabase(dados) {
  const response = await fetch(`${SUPABASE_URL}/rest/v1/BPO_registosNSS`, {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'apikey':SUPABASE_API_KEY,
      'Authorization':`Bearer ${SUPABASE_API_KEY}`,
      'Prefer':'return=representation'
    },
    body:JSON.stringify(dados)
  });
  if(!response.ok){
    const error = await response.json();
    throw new Error(`Erro ${response.status}: ${JSON.stringify(error)}`);
  }
  return await response.json();
}

function formatarDataHoraLocal(date){
  const ano = date.getFullYear();
  const mes = String(date.getMonth()+1).padStart(2,'0');
  const dia = String(date.getDate()).padStart(2,'0');
  const hora = String(date.getHours()).padStart(2,'0');
  const min = String(date.getMinutes()).padStart(2,'0');
  const seg = String(date.getSeconds()).padStart(2,'0');
  return `${ano}-${mes}-${dia}T${hora}:${min}:${seg}`;
}

// Submeter registro
async function submeter(){
  if(!tipoSelecionado){ mostrarMensagem("Selecione um tipo de registo.", false); return; }
  inicioDataHora = new Date();

  if(tipoSelecionado === "login" || tipoSelecionado === "logout"){
    horaIni.textContent = `‚úîÔ∏è Registado`;
    horaIni.style.display='inline-block';
    const dados = {
      data: formatarDataHoraLocal(inicioDataHora).split('T')[0],
      user, nome,
      tipo: tipoSelecionado,
      inicio: formatarDataHoraLocal(inicioDataHora),
      fim: null,
      duracao: null
    };
    try{
      await enviarAoSupabase(dados);
      mostrarMensagem("‚úîÔ∏è Registo enviado com sucesso!");
      btnSub.disabled=true;
    }catch(err){
      mostrarMensagem("‚ùå Erro ao enviar: "+err.message, false);
    }
  } else {
    horaIni.textContent = `üïí In√≠cio: ${inicioDataHora.toLocaleTimeString('pt-BR')}`;
    horaIni.style.display='inline-block';
    iniciarCronometro();
    btnSub.style.display='none';
    btnTerm.style.display='inline-block';
  }
}

// Terminar registro (pausas, refei√ß√£o, forma√ß√£o)
async function terminar(){
  pararCronometro();
  fimDataHora = new Date();
  horaFim.textContent = `üïî Fim: ${fimDataHora.toLocaleTimeString('pt-BR')}`;
  horaFim.style.display='inline-block';

  const duracaoHoras = segundos / 3600;
  const dados = {
    data: formatarDataHoraLocal(inicioDataHora).split('T')[0],
    user, nome,
    tipo: tipoSelecionado,
    inicio: formatarDataHoraLocal(inicioDataHora),
    fim: formatarDataHoraLocal(fimDataHora),
    duracao: parseFloat(duracaoHoras.toFixed(3))
  };

  try{
    await enviarAoSupabase(dados);
    mostrarMensagem("‚úîÔ∏è Registo enviado com sucesso!", true);
  }catch(err){
    mostrarMensagem("‚ùå Erro ao enviar: "+err.message,false);
  }

  // Reset
  btnTerm.style.display='none';
  btnSub.style.display='inline-block';
  btnSub.disabled=true;
  tipoSelecionado="";
  tipoBtns.forEach(b=>b.classList.remove('active'));
}

// Scripts GAMa
let startTime,endTime,timerInterval;
const startButton=document.getElementById('startButton');
const endButton=document.getElementById('endButton');
const tempoTarefa=document.getElementById('tempoTarefa');
const responseMessage=document.getElementById('responseMessage');

function formatTime(seconds){const hours=Math.floor(seconds/3600);const minutes=Math.floor((seconds%3600)/60);const secs=seconds%60;return `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;}
function formatDate(date){const d=date.getDate().toString().padStart(2,'0');const m=(date.getMonth()+1).toString().padStart(2,'0');const y=date.getFullYear();const h=date.getHours().toString().padStart(2,'0');const min=date.getMinutes().toString().padStart(2,'0');const s=date.getSeconds().toString().padStart(2,'0');return `${d}/${m}/${y} ${h}:${min}:${s}`;}

startButton.addEventListener('click',function(){
  startTime=new Date();
  startButton.disabled=true;
  endButton.disabled=false;
  timerInterval=setInterval(()=>{ const elapsed=Math.floor((new Date()-startTime)/1000); tempoTarefa.value=formatTime(elapsed);},1000);
});

endButton.addEventListener('click',function(){
  clearInterval(timerInterval);
  endTime=new Date();
  const elapsed=Math.floor((endTime-startTime)/1000);
  tempoTarefa.value=formatTime(elapsed);
  endButton.disabled=true;

  const processoGama=document.getElementById('processoGama').value;
  const documentos=document.getElementById('documentos').value;
  const tarefaFinalizada=document.getElementById('tarefaFinalizada').value;
  const tempo=tempoTarefa.value;
  const colaborador="Telma Sofia Pereira Rosa";
  const startFormatted=formatDate(startTime);
  const endFormatted=formatDate(endTime);

  fetch(`${SUPABASE_URL}/rest/v1/BPO_dadosprodu√ß√£o`,{
    method:'POST',
    headers:{ 'Content-Type':'application/json','apikey': SUPABASE_API_KEY,'Authorization':`Bearer ${SUPABASE_API_KEY}`,'Prefer':'return=representation'},
    body:JSON.stringify({ inicio:startFormatted, fim:endFormatted, colaborador, processoGama, Documentos:Number(documentos), tarefaFinalizada, tempo })
  }).then(async response=>{ if(!response.ok){ const errorBody=await response.text(); throw new Error(`Erro ${response.status}: ${errorBody}`); } return response.json();})
  .then(data=>{ showMessage('Dados enviados com sucesso!','success'); document.getElementById('gamaForm').reset(); startButton.disabled=false; tempoTarefa.value='';})
  .catch(error=>{ showMessage('Falha ao enviar os dados: '+error.message,'error'); startButton.disabled=false;});

});

function showMessage(message,type){ responseMessage.textContent=message; responseMessage.className='message '+type; responseMessage.style.display='block'; setTimeout(()=>{ responseMessage.style.display='none'; },5000);}
</script>

</body>
</html>

