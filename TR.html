<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Newspring</title>
<style>
:root {
  --primary: #0b1f5e;
  --success: #2e7d32;
  --warning: #ffc107;
  --danger: #d50000;
  --bg: #f7f7f7;
  --card: #ffffff;
  --text: #212529;
  --border: #ddd;
}

body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: var(--bg);
  display: flex;
  min-height: 100vh;
}

/* ================= SIDEBAR ================= */
.sidebar {
  width: 780px; /* maior para mostrar toda a info */
  background: var(--card);
  border-radius: 10px;
  border: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding: 20px;
  height: 100vh;
  box-sizing: border-box;
  position: fixed;
  left: 0;
  top: 0;
}

.sidebar-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.avatar {
  width: 60px;
  height: 60px;
  background: var(--primary);
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  color: white;
  font-weight: bold;
  font-size: 24px;
  margin-right: 10px;
}

.nome { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
.data { font-size: 14px; color: #555; }

#historicoContainer { flex-grow: 1; overflow-y: auto; max-height: calc(100vh - 150px); }
#historicoContainer h3 { font-size: 14px; margin-bottom: 8px; }
.historico-item { font-size: 13px; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.historico-login { color: var(--success); }
.historico-logout { color: var(--danger); }
.historico-pausa { color: var(--warning); }
.historico-refeicao { color: var(--warning); }
.historico-formacao { color: var(--primary); }

/* ================= MAIN ================= */
.main {
  flex-grow: 1;
  max-width: 480px;
  margin-left: 780px; /* mesmo valor da sidebar */
  display: flex;
  flex-direction: column;
  padding: 20px;
}
/* STATUS */
.status-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-left: 6px solid var(--danger);
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 12px;
  text-align: center;
}
#estadoLabel { font-weight: bold; }
/* BOT√ïES ESTADO */
#tipoButtons { display: grid; grid-template-columns: repeat(2,1fr); gap:8px; margin-bottom:12px; }
.tipo-btn { padding:12px; border-radius:6px; border:1px solid var(--border); background: var(--card); font-weight:bold; cursor:pointer; }
[data-tipo="login"] { border-left:4px solid var(--success); }
[data-tipo="logout"] { border-left:4px solid var(--danger); }
[data-tipo^="pausa"], [data-tipo="refeicao"] { border-left:4px solid var(--warning); }
[data-tipo="formacao"] { border-left:4px solid var(--primary); }
/* A√á√ïES */
.actions { text-align:center; margin-bottom:20px; }
.actions button { padding:10px 18px; border-radius:6px; font-weight:bold; border:none; cursor:pointer; margin-right:6px; }
#btnSubmeter { background: var(--primary); color:white; }
#btnTerminar { background: var(--danger); color:white; display:none; }
#mensagem { margin-top:8px; font-weight:bold; text-align:center; }
/* PRODU√á√ÉO */
.form-container {
  background: var(--card);
  border:1px solid var(--border);
  border-radius:10px;
  padding:20px;
  margin-top:20px;
}
.titulo-gama { text-align:center; font-weight:bold; font-size:18px; color: var(--primary); margin-bottom:16px; }
.form-group { margin-bottom:14px; }
.form-group label { font-weight:bold; margin-bottom:4px; display:block; }
input, select { width:100%; padding:10px; border-radius:6px; border:1px solid var(--border); font-size:14px; }
input:focus, select:focus { border-color: var(--primary); outline:none; }
.button-container { display:flex; justify-content:space-between; margin-top:14px; }
.button-container button { width:48%; padding:10px 0; font-weight:bold; border:none; border-radius:6px; cursor:pointer; }
#startButton { background: var(--success); color:white; }
#endButton { background: var(--danger); color:white; }
#tempoTarefa { text-align:center; font-weight:bold; background:#f0f0f0; border-radius:6px; }
#responseMessage { text-align:center; margin-top:12px; font-weight:bold; color: var(--success);}
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-top">
    <div style="display:flex; align-items:center;">
      <div class="avatar" id="avatar">T</div>
      <div>
        <div class="nome" id="nomeUser"></div>
        <div class="data" id="dataHoje"></div>
      </div>
    </div>
    <img src="logo.png" alt="Logo" style="width:60px; height:60px; object-fit:contain;">
  </div>

  <div id="historicoContainer">
    <h3>Hist√≥rico de A√ß√µes</h3>
    <div id="historicoList"></div>
  </div>
</div>

<div class="main">
  <div class="status-card">
    <div id="estadoLabel">üî¥ OFFLINE</div>
  </div>

  <div id="tipoButtons">
    <button class="tipo-btn" data-tipo="login">Login</button>
    <button class="tipo-btn" data-tipo="pausa1">Pausa 1</button>
    <button class="tipo-btn" data-tipo="pausa2">Pausa 2</button>
    <button class="tipo-btn" data-tipo="refeicao">Refei√ß√£o</button>
    <button class="tipo-btn" data-tipo="formacao">Forma√ß√£o</button>
    <button class="tipo-btn" data-tipo="logout">Logout</button>
  </div>

  <div class="actions">
    <button id="btnSubmeter" disabled>Submeter</button>
    <button id="btnTerminar">Finalizar</button>
    <div id="mensagem"></div>
  </div>

  <div class="form-container">
    <h2 class="titulo-gama">Produ√ß√£o - Gest√£o Ocorr√™ncias</h2>
    <form id="gamaForm">
      <div class="form-group">
        <label>Processo</label>
        <input type="text" id="processoGama" required />
      </div>
      <div class="form-group">
        <label>Documentos Tratados</label>
        <input type="number" id="documentos" required />
      </div>
      <div class="form-group">
        <label>Tarefa Finalizada</label>
        <select id="tarefaFinalizada">
          <option>Reembolsos Multicare</option>
          <option>Forma√ß√£o/Meetings</option>
        </select>
      </div>
      <div class="form-group">
        <label>Tempo da Tarefa</label>
        <input type="text" id="tempoTarefa" readonly />
      </div>
      <div class="button-container">
        <button type="button" id="startButton">Iniciar</button>
        <button type="button" id="endButton" disabled>Finalizar</button>
      </div>
      <div id="responseMessage"></div>
    </form>
  </div>
</div>

<script>
const user="EX04904";
const nome="Telma Sofia Pereira Rosa";
const SUPABASE_URL = 'https://bijndfsxrzjviwrdvwms.supabase.co';
const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpam5kZnN4cnpqdml3cmR2d21zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4NTA5NTIsImV4cCI6MjA2NjQyNjk1Mn0.EWaFInuqTaxvnjytb40DdnflEbBrbSYcViKLYc_kKBk';

document.getElementById("nomeUser").textContent = nome;
document.getElementById("avatar").textContent = nome.charAt(0).toUpperCase();
document.getElementById("dataHoje").textContent = new Date().toLocaleDateString('pt-BR');

let tipoSelecionado="";
let inicioDataHora;
let fimDataHora;
let registroAtualId = null; // id do registro no hist√≥rico
const estadoLabel = document.getElementById("estadoLabel");
const btnSub=document.getElementById("btnSubmeter");
const btnTerm=document.getElementById("btnTerminar");
const msgEl=document.getElementById("mensagem");
const historicoList=document.getElementById("historicoList");

function formatarDataHoraLocal(d){
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")+"T"+
         String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0")+":"+String(d.getSeconds()).padStart(2,"0");
}

// Historico com atualiza√ß√£o na mesma linha
let historicoContador = 0;
function registrarHistorico(tipo, inicio, fim=null){
  if(!fim){
    // criar novo registro e salvar ID
    registroAtualId = 'hist-' + historicoContador++;
    const div=document.createElement('div');
    div.className='historico-item historico-'+tipo;
    div.id = registroAtualId;
    div.textContent = tipo.charAt(0).toUpperCase()+tipo.slice(1)+' - In√≠cio: '+inicio.toLocaleTimeString('pt-BR', {hour12:false});
    historicoList.prepend(div);
    return registroAtualId;
  } else {
    // atualizar registro existente
    const divAtual = document.getElementById(registroAtualId);
    const duracao=((fim-inicio)/1000/60).toFixed(1);
    divAtual.textContent += ' | Fim: '+fim.toLocaleTimeString('pt-BR', {hour12:false})+' | Dura√ß√£o: '+duracao+' min';
  }
}

async function enviarAoSupabase(dados, table){
  try{
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "apikey":SUPABASE_API_KEY,
        "Authorization":`Bearer ${SUPABASE_API_KEY}`,
        "Prefer":"return=representation"
      },
      body: JSON.stringify(dados)
    });
    if(!res.ok){
      const errData = await res.json().catch(()=>({message:res.statusText}));
      throw new Error(errData.message||res.statusText);
    }
    return await res.json();
  } catch(err){
    console.error(err);
    msgEl.textContent="‚ùå Erro ao enviar: "+err.message;
  }
}

// Bot√µes de estado
document.querySelectorAll(".tipo-btn").forEach(btn=>{
  btn.onclick=()=>{
    tipoSelecionado=btn.dataset.tipo;
    inicioDataHora=new Date();
    fimDataHora=null;
    btnSub.disabled=false;
    btnSub.style.display="inline-block";
    btnTerm.style.display="none";
    msgEl.textContent="";
    let cor="";
    if(tipoSelecionado==="login"){ 
      estadoLabel.textContent="üü¢ ONLINE"; cor="--success";
    } else if(tipoSelecionado==="logout"){ 
      estadoLabel.textContent="üî¥ OFFLINE"; cor="--danger";
    } else { 
      estadoLabel.textContent="‚è∏ "+btn.textContent; cor="--warning"; 
    }
    document.querySelector(".status-card").style.borderLeftColor=getComputedStyle(document.documentElement).getPropertyValue(cor);

    // registrar inicio no hist√≥rico
    registrarHistorico(tipoSelecionado,inicioDataHora);
  }
});

// Submeter / Finalizar
btnSub.onclick=()=>{
  const dataHoje=formatarDataHoraLocal(inicioDataHora).split("T")[0];
  if(tipoSelecionado==="login"||tipoSelecionado==="logout"){
    enviarAoSupabase({
      data:dataHoje,
      user,
      nome,
      tipo:tipoSelecionado,
      inicio:formatarDataHoraLocal(inicioDataHora),
      fim:null,
      duracao:null
    },"BPO_registosNSS");
    btnSub.disabled=true;
  } else {
    btnSub.style.display="none";
    btnTerm.style.display="inline-block";
    btnTerm.onclick=async ()=>{
      fimDataHora=new Date();
      registrarHistorico(tipoSelecionado,inicioDataHora,fimDataHora);
      await enviarAoSupabase({
        data:dataHoje,
        user,
        nome,
        tipo:tipoSelecionado,
        inicio:formatarDataHoraLocal(inicioDataHora),
        fim:formatarDataHoraLocal(fimDataHora),
        duracao:parseFloat(((fimDataHora-inicioDataHora)/3600000).toFixed(3))
      },"BPO_registosNSS");
      btnTerm.style.display="none";
      btnSub.style.display="inline-block";
      btnSub.disabled=true;
      estadoLabel.textContent="üü¢ ONLINE";
      document.querySelector(".status-card").style.borderLeftColor="var(--success)";
    };
  }
};

// Produ√ß√£o
let startTime,endTime,timerInterval;
const startButton=document.getElementById('startButton');
const endButton=document.getElementById('endButton');
const tempoTarefa=document.getElementById('tempoTarefa');
const responseMessage=document.getElementById('responseMessage');

function formatTime(seconds){
  const h=Math.floor(seconds/3600);
  const m=Math.floor((seconds%3600)/60);
  const s=seconds%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

startButton.onclick=()=>{
  responseMessage.textContent="";
  startTime=new Date();
  startButton.disabled=true;
  endButton.disabled=false;
  timerInterval=setInterval(()=>{
    tempoTarefa.value=formatTime(Math.floor((new Date()-startTime)/1000));
  },1000);
};

endButton.onclick=async ()=>{
  clearInterval(timerInterval);
  endTime=new Date();
  endButton.disabled=true;
  await enviarAoSupabase({
    inicio:startTime.toISOString(),
    fim:endTime.toISOString(),
    colaborador:nome,
    processoGama:document.getElementById('processoGama').value,
    Documentos:Number(document.getElementById('documentos').value),
    tarefaFinalizada:document.getElementById('tarefaFinalizada').value,
    tempo:tempoTarefa.value
  },"BPO_dadosprodu√ß√£o");
  responseMessage.textContent="‚úîÔ∏è Produ√ß√£o enviada";
  document.getElementById('gamaForm').reset();
  startButton.disabled=false;
};
</script>
</body>
</html>
