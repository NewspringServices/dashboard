<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Newspring</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f7f7f7;
    }
    #topImage {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 150px;
      height: auto;
    }
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .tabs button {
      padding: 10px 20px;
      margin: 0 5px;
      border: none;
      cursor: pointer;
      background-color: #ccc;
      border-radius: 5px;
    }
    .tabs button.active {
      background-color: #28a745;
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .barra-registo {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      gap: 15px;
      max-width: 500px;
      margin: auto 0 20px;
    }
    .barra-registo .info-usuario {
      font-weight: bold;
      text-align: center;
    }
    .barra-registo .select-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
    }
    .barra-registo select {
      width: 200px;
      padding: 8px;
    }
    .barra-registo button#btnSubmeter {
      padding: 6px 12px;
      font-size: 14px;
    }
    .status {
      font-size: 14px;
    }
    #mensagem {
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
    }

    .form-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      margin: auto;
    }
    .form-group {
      margin-bottom: 15px;
    }
    select, input[type="text"], input[type="number"], button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    .button-container {
      display: flex;
      justify-content: space-between;
    }
    .button-container button {
      width: 48%;
    }
    .message {
      text-align: center;
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .success { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
    .titulo-gama {
      font-size: 20px;
      color: #28a745;
      text-align: center;
      margin-bottom: 20px;
    }
    #cronometro { display: none !important; }
  </style>
</head>
<body>

  <img id="topImage" src="logo.png" alt="Logo Newspring" />

  <div class="tabs">
    <button class="tab-btn active" onclick="showTab('fybdo')">Registos NSS</button>
    <button class="tab-btn" onclick="showTab('gama')">Plataforma Produ√ß√£o</button>
  </div>

  <!-- FYBDO -->
  <div id="fybdo" class="tab-content active">
    <div class="barra-registo">
      <div id="infoData"></div>
      <div class="info-usuario">User: EX10883<br>Nome: Jo√£o Nuno da Silva Cardoso</div>
      <div class="select-row">
        <label for="tipo">Tipo:</label>
        <select id="tipo">
          <option value="">Selecione</option>
          <option value="login">Login</option>
          <option value="logout">Logout</option>
          <option value="pausa1">Pausa 1</option>
          <option value="pausa2">Pausa 2</option>
          <option value="refeicao">Refei√ß√£o</option>
          <option value="formacao">Forma√ß√£o</option>
        </select>
        <button id="btnSubmeter">Submeter</button>
      </div>
      <span id="cronometro" class="status">‚è± 00:00:00</span>
      <span id="horaInicio" class="status"></span>
      <span id="horaFim" class="status"></span>
      <button id="btnTerminar" class="status">Terminar</button>
      <span id="mensagem"></span>
    </div>
  </div>

  <!-- GAMA -->
  <div id="gama" class="tab-content">
    <div class="form-container">
      <h2 class="titulo-gama">Produ√ß√£o - GAMA</h2>
      <form id="gamaForm">
        <div class="form-group">
          <label for="tarefaFinalizada">Tarefa Finalizada:</label>
          <select id="tarefaFinalizada" required>
            <option value="">-- Selecione --</option>
            <option value="AT">AT</option>
            <option value="DNP">DNP</option>
            <option value="AP">AP</option>
            <option value="PETS">PETS</option>
            <option value="Forma√ß√£o/Meetings">Forma√ß√£o/Meetings</option>
          </select>
        </div>
        <div class="form-group" id="suboptions">
          <label for="subopcao">Subop√ß√£o:</label>
          <select id="subopcao">
            <option value="">-- Escolha --</option>
            <option value="IBAN">IBAN</option>
            <option value="IBAN+Indexa√ß√£o">IBAN+Indexa√ß√£o</option>
            <option value="Reentrada c/ Indexa√ß√£o">Reentrada c/ Indexa√ß√£o</option>
            <option value="Indexa√ß√µes">Indexa√ß√µes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="numero-processo">N√∫mero de Processo/GAMA:</label>
          <input type="text" id="numero-processo" name="numero-processo" required>
        </div>
        <div class="form-group" id="documentosGroup">
          <label for="documentos">N√∫mero de Documentos:</label>
          <input type="number" id="documentos" min="1" placeholder="Digite o n√∫mero de documentos" />
        </div>
        <div class="form-group">
          <label for="tempoTarefa">Tempo da Tarefa:</label>
          <input type="text" id="tempoTarefa" readonly>
        </div>
        <div class="button-container">
          <button type="button" id="startButton">Iniciar Tarefa</button>
          <button type="button" id="endButton" disabled>Finalizar Tarefa</button>
        </div>
        <div id="responseMessage" class="message"></div>
      </form>
    </div>
  </div>

<script>
  // Configura√ß√µes
  const user = "EX10883";
  const nome = "Jo√£o Nuno da Silva Cardoso";
  const SUPABASE_URL = 'https://bijndfsxrzjviwrdvwms.supabase.co';
  const SUPABASE_API_KEY = 'YOUR_SUPABASE_KEY';

  // Elementos FYBDO
  const tipo = document.getElementById('tipo');
  const btnSubmeter = document.getElementById('btnSubmeter');
  const btnTerminar = document.getElementById('btnTerminar');
  const infoData = document.getElementById('infoData');
  const cronometro = document.getElementById('cronometro');
  const horaInicio = document.getElementById('horaInicio');
  const horaFim = document.getElementById('horaFim');
  const mensagem = document.getElementById('mensagem');
  let timer, segundos = 0, inicio;

  // GAMA elementos
  const tarefaFinalizada = document.getElementById('tarefaFinalizada');
  const subopcao = document.getElementById('subopcao');
  const suboptions = document.getElementById('suboptions');
  const documentosGroup = document.getElementById('documentosGroup');
  const documentos = document.getElementById('documentos');
  const numeroProcesso = document.getElementById('numero-processo');
  const startButton = document.getElementById('startButton');
  const endButton = document.getElementById('endButton');
  const tempoTarefa = document.getElementById('tempoTarefa');
  const responseMessage = document.getElementById('responseMessage');
  let startTime, timerInterval;

  // Inicia interface
  infoData.textContent = 'üìÖ ' + new Date().toLocaleDateString('pt-BR');
  cronometro.style.display = horaInicio.style.display = horaFim.style.display =
    btnTerminar.style.display = 'none';

  // Tab switching
  function showTab(id) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.onclick.toString().includes(id)));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.toggle('active', t.id === id));
  }

  // FYBDO registro
  tipo.addEventListener('change', () => {
    btnSubmeter.disabled = !tipo.value;
    cronometro.textContent = '‚è± 00:00:00';
    cronometro.style.display = horaInicio.style.display = horaFim.style.display = btnTerminar.style.display = 'none';
    mensagem.textContent = '';
  });

  btnSubmeter.addEventListener('click', () => {
    if (!tipo.value) return;
    inicio = new Date();
    if (['login', 'logout'].includes(tipo.value)) {
      horaInicio.textContent = '‚úîÔ∏è Registado';
      horaInicio.style.display = 'inline-block';
      enviar({ tipo: tipo.value, inicio, fim: null, duracao: null }, 'registosNSS');
    } else {
      cronometro.style.display = 'inline-block';
      timer = setInterval(() => {
        segundos++;
        const h = String(Math.floor(segundos / 3600)).padStart(2,'0');
        const m = String(Math.floor((segundos % 3600)/60)).padStart(2,'0');
        const s = String(segundos % 60).padStart(2,'0');
        cronometro.textContent = `‚è± ${h}:${m}:${s}`;
      }, 1000);
      horaInicio.textContent = 'üïí In√≠cio: ' + inicio.toLocaleTimeString('pt-BR');
      horaInicio.style.display = 'inline-block';
      btnSubmeter.style.display = 'none';
      btnTerminar.style.display = 'inline-block';
    }
  });

  btnTerminar.addEventListener('click', () => {
    clearInterval(timer);
    const fim = new Date();
    const dur = (segundos/3600).toFixed(3);
    horaFim.textContent = 'üïî Fim: ' + fim.toLocaleTimeString('pt-BR');
    horaFim.style.display = 'inline-block';
    enviar({ tipo: tipo.value, inicio, fim, duracao: parseFloat(dur) }, 'registosNSS');
    btnTerminar.style.display='none';
    btnSubmeter.style.display='inline-block';
    btnSubmeter.disabled=true;
    tipo.value='';
    segundos=0;
  });

  // GAMA l√≥gica
  tarefaFinalizada.addEventListener('change', () => {
    suboptions.style.display = tarefaFinalizada.value==='AT' ? 'block' : 'none';
    documentosGroup.style.display = ['AP','DNP','PETS','Forma√ß√£o/Meetings'].includes(tarefaFinalizada.value)
      ? 'block' : 'none';
  });

  startButton.addEventListener('click', () => {
    startTime = new Date();
    startButton.disabled = true;
    endButton.disabled = false;
    timerInterval = setInterval(() => {
      const elapsed = Math.floor((new Date() - startTime)/1000);
      const h = String(Math.floor(elapsed/3600)).padStart(2,'0');
      const m = String(Math.floor((elapsed%3600)/60)).padStart(2,'0');
      const s = String(elapsed%60).padStart(2,'0');
      tempoTarefa.value = `${h}:${m}:${s}`;
    }, 1000);
  });

  endButton.addEventListener('click', () => {
    clearInterval(timerInterval);
    endButton.disabled = true;
    const fim = new Date();
    const inicioStr = startTime.toISOString();
    const fimStr = fim.toISOString();
    const tempo = tempoTarefa.value;
    const tarefa = tarefaFinalizada.value + (subopcao.value ? ` - ${subopcao.value}` : '');
    const nrProc = numeroProcesso.value;
    const documentosQtd = tarefaFinalizada.value==='AT'? '1' : documentos.value || '';

    const payload = [{
      colaborador: nome,
      inicio_da_tarefa: inicioStr,
      fim_da_tarefa: fimStr,
      tarefa_finalizada: tarefa,
      tempo_com_a_tarefa: tempo,
      documentos: documentosQtd,
      numero_processo: nrProc
    }];

    enviar(payload, 'gama_producao')
      .then(() => {
        responseMessage.textContent='‚úîÔ∏è Enviado com sucesso!';
        responseMessage.className='message success';
        responseMessage.style.display='block';
        setTimeout(()=>responseMessage.style.display='none',5000);
        document.getElementById('gamaForm').reset();
        startButton.disabled=false;
        tempoTarefa.value='';
        suboptions.style.display='none';
        documentosGroup.style.display='none';
        endButton.disabled=true;
      })
      .catch(()=> {
        responseMessage.textContent='‚ùå Erro no envio';
        responseMessage.className='message error';
        responseMessage.style.display='block';
        startButton.disabled=false;
      });
  });

  // Fun√ß√£o de envio
  async function enviar(data, tabela) {
    const body = tabela==='registosNSS'
      ? { data: new Date().toISOString().split('T')[0], user, nome, ...data }
      : data;

    const res = await fetch(`${SUPABASE_URL}/rest/v1/${tabela}`, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'apikey':SUPABASE_API_KEY,
        'Authorization':`Bearer ${SUPABASE_API_KEY}`,
        'Prefer':'return=representation'
      },
      body: JSON.stringify(tabela==='registosNSS' ? body : data)
    });
    if (!res.ok) throw new Error(res.status);
    mensagem.textContent = '‚úîÔ∏è Sucesso';
    mensagem.style.color='green';
    setTimeout(()=>mensagem.textContent='',3000);
    return res.json();
  }

</script>

</body>
</html>
